---
title: "Pythonにおける計算誤差・丸め誤差を理解する"
emoji: "🐺"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: [python3, 計算誤差, 丸め誤差]
published: false
---

> アドベントカレンダー（自称）vol.23

皆さん、こんにちは。yumyum116 です。SWE転職を目指す者です。
アドベントカレンダーに便乗して、1日1記事投稿に挑戦するとともに、執筆活動の習慣化にも挑戦してみます。

本記事は、頭休めになるような、それでいて、学びにもなるtipsを取り扱います。
今回のテーマは `計算誤差・丸め誤差` についてお届けします。

## 1. 計算誤差・丸め誤差とは
### 計算誤差とは
英語では、floating point error と訳されます。これは、**多くの小数が２進数で有限に表現できないため、python の float は「近似値」を保持している** ことに起因します。
例えば、次のような場合です。

```
0.1 + 0.2
# 0.30000000000000004
```

これはバグではなく、仕様通りの結果です。

### 丸め誤差とは
英語では、rounding error と訳されます。これは、計算途中で発生する誤差が繰り返し演算で蓄積され、表示上は丸めることができても、内部値の誤差が残っている状態を指します。
例えば、次のような場合です。

```
sum([0.1] * 10)
# 0.9999999999999999
```

## 2. 計算誤差・丸め誤差はどのような場合に問題となるのか
主に、次のような場合に致命傷になりやすいです。

### (1) 金額計算
```
price = 0.1
total = price * 3
# 0.30000000000000004
```
請求額や税計算、為替計算などの場面において、１円未満のズレが件数分だけ積み上がります。

### (2) 比較処理が壊れる
例えば、次のような場合です。

```
if total == 0.3:
    ...
```
内部値としては一致しないため、条件分岐が誤動作のトリガーとなる可能性があります。とくに、バッチ処理や会計締めの場面では大きな問題となります。

### (3) 集計・分析結果が一致しない
平均値、分散、累積和、KPI/指標計算等を求める場合に、レポートと実数が一致しない結果となります。

### (4) 境界判定
```
if score >= 1.0:
# score = 0.99999999997
```
閾値を跨がないため、境界判定結果が常に False となります。

## 3. 計算誤差・丸め誤差への対応
本章では、前章の誤差を実務上どのように取り扱うか、について説明します。

### (1) 金額・正確性が求められる場合には、`decimal.Decimal` を使う
実装は次のようになります。

```
from decimal import Decimal

Decimal("0.1") + Decimal("0.2")
# Decimal('0.3')
```
主に、金融領域や会計、契約金額を計算する場面で使われます。

### (2) 比較は誤差込みで行う
小数で表される値を比較したい場合には、"==" を使わず、次のようにして比較を行います。

```
import math

math.isclose(a, b, rel_tol=1e-9)
```

### (3) 整数スケールで扱う
```
price = 100  # 100円
total = price * 3  # 300円
```
税率計算は最後にまとめて行います。

### (4) Numpy / 科学計算においては、誤差前提で設計する
例えば、次のような設計により、許容誤差（epsilon）を明示したり、累積誤差が支配的になる箇所を把握できるようにします。

```
# 例１（コード内に許容誤差を明示）
import math

EPS = 1e-9  # 許容誤差

if math.isclose(a, b, rel_tol=EPS):
    ...
```

```
# 例２（ドメインごとに許容誤差を明示）
TOLERANCE_PRICE = 1e-6
TOLERANCE_SCORE = 1e-9

def equal_price(a, b):
    return abs(a - b) < TOLERANCE_PRICE
```

```
# 例３（境界判定を、幅をもたせた設計とする）
def is_qualified(score):
    return score > 1.0 - 1e-9
```

このように、誤差への対応方法は種々あるものの、基本的には float を使ってもよい計算はある程度決まっています。

#### float の使用は避けた方がよいケース
| 分野          | 理由 |
| ------------ | ---- |
| 金額・請求・税 | １円誤差が許容されないため |
| 会計・決算 | 監査や法的リスクの観点 |
| ポイント・残高 | 累積誤差の影響を無視できないため |
| 契約条件 | 閾値判定が壊れるため |
| ID・キー計算 | 一意性が壊れるため |

#### float を使ってよいケース
| 分野          | 理由 |
| ------------ | ---- |
| 科学計算 | 誤差前提で数値を取り扱うため |
| 機械学習 | 数値近似が前提のため |
| グラフ描画 | GPUや描画ライブラリがそもそも float 前提のため、Decimal を使ったとしても丸められるため |
| 物理量 | 実測値自体が誤差を含むため |
| 正規化・スコア | 相対比較においてのみ許容される |

ここで触れられなかった、KPI、評価スコア、レーティング、分析指標等は、都度設計判断が必要です。

この、浮動小数点数の取り扱いを定めた規格（IEEE754）や、Numpy は誤差を前提に設計されている理由など、関連する内容はいくつかありますが、紙幅の都合上、別の記事に分けることとします。

-----

記事内に誤謬等ございます場合には、修正いたします。

それでは、また。
